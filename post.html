<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Niveditha S. Iyer">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">

    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <title id="page-title">Writing | Niveditha Iyer</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: "Manrope", sans-serif;
            height: 100%;
            color: #333;
            background-color: #fffdfc;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 40px 20px;
            justify-content: flex-start;
            line-height: 1.6;
            opacity: 0;
            animation: fadeInPage 0.6s ease forwards;
        }

        @keyframes fadeInPage {
            to { opacity: 1; }
        }

        /* Nav */
        .site-nav {
            width: 60%;
            margin: 0 auto 10px auto;
            padding: 0 0 4px 0;
            font-family: "Manrope", sans-serif;
            font-size: 0.85rem;
            letter-spacing: 0.03em;
            text-align: right;
        }

        .nav-link {
            color: #999;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #333;
        }

        .nav-separator {
            color: #ccc;
            margin: 0 8px;
        }

        /* Post article */
        .post {
            width: 60%;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.6s ease 0.1s, transform 0.6s ease 0.1s;
        }

        .post.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Markdown rendered content */
        .post h1 {
            font-family: "Manrope", sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            line-height: 1.3;
            margin-top: 0;
            margin-bottom: 8px;
        }

        .post h1 + p {
            margin-top: 24px;
        }

        .post h2 {
            font-family: "EB Garamond", serif;
            font-size: 1.35rem;
            color: #666;
            font-weight: 400;
            font-style: italic;
            line-height: 1.4;
            margin-top: 0;
            margin-bottom: 24px;
        }

        .post h3 {
            font-family: "Manrope", sans-serif;
            font-size: 1.25rem;
            color: #555;
            font-weight: 600;
            line-height: 1.3;
            margin-top: 2em;
            margin-bottom: 0.5em;
        }

        .post h4 {
            font-family: "Manrope", sans-serif;
            font-size: 1.1rem;
            color: #777;
            line-height: 1.3;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .post p {
            font-family: "EB Garamond", serif;
            font-size: 1.15rem;
            color: #444;
            line-height: 1.75;
            margin-bottom: 1.2em;
        }

        .post a {
            color: #1a8e18;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s ease;
        }

        .post a:hover {
            border-bottom-color: #1a8e18;
        }

        /* Script tables */
        .post table.script-table {
            width: 90%;
            border-collapse: collapse;
            font-family: "EB Garamond", serif;
            font-size: inherit;
            color: #444;
            margin: 1.2em auto;
            line-height: 1.75;
        }

        .post table.script-table td {
            vertical-align: top;
            padding: 0.1em 0;
            font-family: inherit;
        }

        .post table.script-table .speaker {
            width: 6rem;
            font-weight: 600;
            color: #666;
            padding-right: 0.6rem;
            white-space: nowrap;
        }

        .post table.script-table .line {
            width: auto;
        }

        /* Blockquotes */
        .post blockquote {
            border-left: 3px solid #1a8e18;
            margin: 1.5em 0;
            padding: 0.5em 0 0.5em 1.5em;
            background-color: #faf8f6;
            border-radius: 0 4px 4px 0;
        }

        .post blockquote p {
            color: #666;
            font-style: normal;
            margin-bottom: 0.5em;
        }

        .post blockquote p:last-child {
            margin-bottom: 0;
        }

        /* Code */
        .post pre {
            background-color: #f7f5f3;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 16px 20px;
            overflow-x: auto;
            margin: 1.5em 0;
        }

        .post code {
            font-family: "SF Mono", "Fira Code", "Consolas", monospace;
            font-size: 0.9rem;
        }

        .post p code,
        .post li code {
            background-color: #f7f5f3;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85em;
        }

        /* Lists */
        .post ul,
        .post ol {
            font-family: "EB Garamond", serif;
            font-size: 1.15rem;
            color: #444;
            line-height: 1.75;
            margin: 1em 0 1em 1.5em;
        }

        .post li {
            margin-bottom: 0.4em;
        }

        /* Images */
        .post img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1.5em 0;
        }

        /* Drop cap */
        .post p.dropcap::first-letter {
            font-family: "EB Garamond", serif;
            font-size: 3.5em;
            float: left;
            line-height: 0.8;
            margin-right: 8px;
            margin-top: 6px;
            color: #333;
            font-weight: 600;
        }

        /* Citations */
        .cite-ref {
            font-size: 0.75em;
            vertical-align: super;
            line-height: 0;
            color: #1a8e18;
            font-weight: 600;
            cursor: pointer;
            font-family: "Manrope", sans-serif;
            padding: 0 1px;
        }

        .cite-ref:hover {
            color: #147012;
        }

        .cite-sep {
            font-size: 0.75em;
            vertical-align: super;
            line-height: 0;
            color: #999;
        }

        .cite-tooltip {
            position: fixed;
            max-width: 360px;
            padding: 12px 16px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            font-size: 0.9rem;
            line-height: 1.5;
            color: #555;
            font-family: "EB Garamond", serif;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .cite-tooltip.visible {
            opacity: 1;
        }

        /* Horizontal rules */
        .post hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 2em 0;
        }

        /* Post footer */
        .post-footer {
            width: 60%;
            margin: 40px auto 60px auto;
            opacity: 0;
            transition: opacity 0.6s ease 0.3s;
        }

        .post-footer.visible {
            opacity: 1;
        }

        .back-link {
            font-family: "Manrope", sans-serif;
            font-size: 0.9rem;
            color: #999;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #1a8e18;
        }

        /* Loading state */
        .post-loading {
            font-family: "EB Garamond", serif;
            font-size: 1.1rem;
            color: #999;
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .site-nav,
            .post,
            .post-footer {
                width: 95%;
            }
        }

        @media (max-width: 768px) {
            .site-nav,
            .post,
            .post-footer {
                width: 100%;
            }

            .post h1 {
                font-size: 1.6rem;
            }

            .post h2 {
                font-size: 1.15rem;
            }

            .post p {
                font-size: 1.05rem;
            }
        }

        @media (max-width: 480px) {
            .site-nav,
            .post,
            .post-footer {
                width: 100%;
            }

            .post h1 {
                font-size: 1.4rem;
            }

            .post h2 {
                font-size: 1.05rem;
            }

            .post p {
                font-size: 1rem;
            }

            .post pre {
                padding: 12px;
                font-size: 0.8rem;
            }

            .cite-tooltip {
                max-width: 280px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <nav class="site-nav">
        <a href="/" class="nav-link">Home</a>
        <span class="nav-separator">/</span>
        <a href="/writing.html" class="nav-link active">Writing</a>
        <span class="nav-separator">/</span>
        <a href="/art.html" class="nav-link">Art</a>
    </nav>

    <article class="post" id="post-content">
        <p class="post-loading">Loading...</p>
    </article>

    <div class="post-footer" id="post-footer">
        <a href="/writing.html" class="back-link">&larr; Back to Writing</a>
    </div>

    <script>
        async function loadPost() {
            var params = new URLSearchParams(window.location.search);
            var slug = params.get('slug');

            if (!slug) {
                document.getElementById('post-content').innerHTML = '<p>Post not found.</p>';
                return;
            }

            try {
                // Fetch metadata for the page title
                var metaResponse = await fetch('/blogs/index.json');
                var posts = await metaResponse.json();
                var postMeta = posts.find(function(p) { return p.slug === slug; });

                if (postMeta) {
                    document.getElementById('page-title').textContent =
                        postMeta.title + ' | Niveditha Iyer';
                }

                // Fetch the markdown file
                var mdResponse = await fetch('/blogs/' + encodeURIComponent(slug) + '.md');
                if (!mdResponse.ok) throw new Error('Post not found');
                var markdown = await mdResponse.text();

                // Extract [citations] section and build citeList
                var citeList = [null]; // 1-indexed
                var markdownBody = markdown;
                var citeSplit = markdown.split(/\n\[citations\]\s*\n/);
                if (citeSplit.length > 1) {
                    markdownBody = citeSplit[0];
                    var lines = citeSplit[1].split('\n');
                    lines.forEach(function(line) {
                        var m = line.match(/^\[(\d+)\]\s+(.+)/);
                        if (m) citeList[parseInt(m[1])] = m[2].trim();
                    });
                }

                // Replace [N] and [N,M] patterns with superscript HTML
                markdownBody = markdownBody.replace(/\[(\d+(?:,\s*\d+)*)\]/g, function(match, inner) {
                    var nums = inner.split(/,\s*/);
                    // Only replace if all numbers exist in citeList
                    var allValid = nums.every(function(n) { return citeList[parseInt(n)]; });
                    if (!allValid) return match;
                    return nums.map(function(n) {
                        return '<sup class="cite-ref" data-cite="' + n.trim() + '">' + n.trim() + '</sup>';
                    }).join('<sup class="cite-sep">,</sup>');
                });

                // Configure marked with highlight.js
                marked.setOptions({
                    gfm: true,
                    breaks: false,
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });

                // Render
                var postEl = document.getElementById('post-content');
                postEl.innerHTML = marked.parse(markdownBody);

                // Process {dc} drop cap markers
                postEl.querySelectorAll('p').forEach(function(p) {
                    if (p.textContent.indexOf('{dc}') === 0) {
                        p.innerHTML = p.innerHTML.replace('{dc}', '');
                        p.classList.add('dropcap');
                    }
                });

                // Set up citation tooltips
                if (citeList.length > 1) {
                    setupCiteTooltip(citeList);
                }

                // Trigger fade-in
                requestAnimationFrame(function() {
                    postEl.classList.add('visible');
                    document.getElementById('post-footer').classList.add('visible');
                });

            } catch (err) {
                document.getElementById('post-content').innerHTML =
                    '<p>Sorry, this post could not be loaded.</p>';
                document.getElementById('post-footer').classList.add('visible');
            }
        }

        // Create and manage the citation tooltip
        function setupCiteTooltip(citeList) {
            var tooltip = document.createElement('div');
            tooltip.className = 'cite-tooltip';
            document.body.appendChild(tooltip);

            function showAt(ref) {
                var num = parseInt(ref.getAttribute('data-cite'));
                if (!citeList[num]) return;

                tooltip.textContent = citeList[num];
                // Position off-screen to measure
                tooltip.style.left = '-9999px';
                tooltip.style.top = '-9999px';
                tooltip.classList.add('visible');

                var rect = ref.getBoundingClientRect();
                var tw = tooltip.offsetWidth;
                var th = tooltip.offsetHeight;

                var left = rect.left + rect.width / 2 - tw / 2;
                left = Math.max(8, Math.min(left, window.innerWidth - tw - 8));

                var top = rect.top - th - 8;
                if (top < 8) top = rect.bottom + 8;

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }

            function hide() {
                tooltip.classList.remove('visible');
            }

            // Hover
            document.addEventListener('mouseover', function(e) {
                var ref = e.target.closest('.cite-ref');
                if (ref) showAt(ref);
            });
            document.addEventListener('mouseout', function(e) {
                var ref = e.target.closest('.cite-ref');
                if (ref) hide();
            });

            // Tap for mobile
            document.addEventListener('click', function(e) {
                var ref = e.target.closest('.cite-ref');
                if (ref) {
                    e.preventDefault();
                    if (tooltip.classList.contains('visible')) {
                        hide();
                    } else {
                        showAt(ref);
                    }
                } else {
                    hide();
                }
            });
        }

        loadPost();
    </script>
</body>

</html>
